<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<dom-module id="things-new-dialog">
  <template>

    <style>
    </style>
    <paper-dialog id="new">
      <h2>[[title]]</h2>
      
      <paper-input label="name"
                   value="{{name::input}}"
                   auto-validate
                   pattern="[a-zA-Z-0-9]*"
                   error-message="letters & dash only!">
      </paper-input>

      <paper-textarea label="description"
                      value="{{description::input}}">
      </paper-textarea>

      <paper-dropdown-menu label="group"
                           value="{{groupName}}"
                           vertical-align="top"
                           horizontal-align="left">

        <paper-menu class="dropdown-content" selected="{{selectedGroup(groupName)}}">
          <template is="dom-repeat" items="{{showGroups}}">
            <paper-item>{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-input label="width" type="number" value="{{width::input}}"></paper-input>
      <paper-input label="height" type="number" value="{{height::input}}"></paper-input>
      <paper-input label="tags" type="string" value="{{tags::input}}"></paper-input>

      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Create</paper-button>
      </div>
    <paper-dialog>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'things-new-dialog',

        properties: {
          group: {
            type: String,
            notify: true,
            observer: 'onGroupChanged'
          },
          groups: {
            notify: true,
            observer: 'onGroupsChanged'
          },

          groupName: {
            notify: true,
          },

          showGroups: {
            type: Array,
            notify: true
          },

          showPlayGroup: {
            notify: true
          },

          title: {
            type: String
          },

          unit: {
            type: String
          },

          scale: {
            type: Number,
            value: 1
          },

          object: {
            type: Object,
            value: {},
            notify: true,
            computed: 'computeObject(name,description,group,width,height,tags)'
          }
        },

        behaviors: [
          Things.MsgBoxBehavior
        ],

        listeners: {

        },

        created: function() {
        },

        onGroupChanged(group) {
          if(!this.groups)
            return

          if (!group) return;

          for(var i = 0;i < this.groups.length;i++) {
            if(this.groups[i].id == group) {
              this.groupName = this.groups[i].name;
              return i;
            }
          }
        },

        onGroupsChanged(groups) {
          if (!groups) {
            return;
          }

          if (this.showPlayGroup) {
            this.showGroups = groups;
            return;
          }

          var showGroups = [];
          groups.forEach(function(g) {
            if (g.category !== 'PLAY') {
              showGroups.push(g)
            }
          });

          this.showGroups = showGroups;

          this.onGroupChanged(this.group);
        },

        computeObject(name, description, group, width, height, tags) {
          if (!group) return;

          var scale = this.scale;

          var model = {
            unit: this.unit,
            left: 0,
            top: 0,
            width: width * scale || 100,
            height: height * scale || 100,
            components: [],
            links: [],
            variables: []
          }

          var groupId;
          for(var i = 0;i < this.groups.length; i++) {
            if(this.groups[i].name === this.groupName) {
              groupId = this.groups[i].id;
            }
          }

          return {
            name: name,
            description: description,
            label_group_id: groupId,
            width: width * scale || 1200,
            height: height * scale || 800,
            tags: tags,
            model: JSON.stringify(model),
            thumbnail: 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='
          }
        },

        show: function() {
          var dialog = this.$["new"].open();
        },

        selectedGroup: function(groupName) {
          if(!this.groups)
            return

          if (!groupName) return;

          for(var i = 0;i < this.groups.length;i++) {
            if(this.groups[i].name == groupName) {
              return i;
            }
          }
        }

      });
    })();
  </script>
</dom-module>
